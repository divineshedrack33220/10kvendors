<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - 10kVendor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-orange: #FF7A2F;
            --secondary-brown: #3E2723;
            --accent-cream: #FFF6ED;
            --neutral-gray: #555555;
            --light-gray: #EDEDED;
            --alert-red: #EF4444;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--accent-cream);
            color: var(--secondary-brown);
        }
        .payment-method {
            transition: all 0.3s ease;
        }
        .payment-method.active {
            border-color: var(--primary-orange);
            background-color: rgba(255, 122, 47, 0.05);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10,10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .ripple:active:after {
            transform: scale(0,0);
            opacity: .3;
            transition: 0s;
        }
        .toast {
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            z-index: 50;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 0.75rem;
            line-height: 1rem;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success {
            background-color: #10B981;
            color: white;
        }
        .toast.error {
            background-color: var(--alert-red);
            color: white;
        }
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
        }
        .checkout-loader {
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(to right, #f6f6f6 0%, #edeef1 20%, #f6f6f6 40%, #f6f6f6 100%);
            background-size: 200% 100%;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="min-h-screen pb-24 md:pb-0">
    <header class="bg-white shadow-sm sticky top-0 z-10" role="banner">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <button onclick="history.back()" class="p-2 rounded-full hover:bg-gray-100 ripple" aria-label="Go back">
                <i data-feather="arrow-left" class="text-gray-700" aria-hidden="true"></i>
            </button>
            <h1 class="text-lg font-bold" aria-label="Checkout page">Checkout</h1>
            <div class="flex items-center space-x-4" id="auth-links"></div>
        </div>
    </header>
    <main class="container mx-auto px-4 py-4 md:px-6 lg:max-w-4xl" role="main">
        <div id="checkout-loader" class="space-y-4 hidden">
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="bg-gray-50 p-3 rounded-lg space-y-2">
                    <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                    <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    <div class="h-4 w-3/4 bg-gray-200 rounded checkout-loader"></div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/2 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3 mt-3">
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                    <div class="flex justify-between">
                        <div class="h-4 w-1/3 bg-gray-200 rounded checkout-loader"></div>
                        <div class="h-4 w-1/4 bg-gray-200 rounded checkout-loader"></div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm">
                <div class="h-6 w-1/2 bg-gray-200 rounded checkout-loader mb-3"></div>
                <div class="space-y-2">
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                    <div class="h-12 w-full bg-gray-200 rounded-lg checkout-loader"></div>
                </div>
            </div>
            <div class="h-10 w-full bg-gray-200 rounded-full checkout-loader"></div>
        </div>
        <div id="checkout-content">
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="font-bold flex items-center">
                        <i data-feather="map-pin" class="w-4 h-4 mr-2 text-orange-500" aria-hidden="true"></i>
                        Delivery Address
                    </h2>
                    <button class="text-sm text-orange-500 ripple" id="change-address" aria-label="Change delivery address">Change</button>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg" id="address-container">
                    <p class="text-sm text-gray-600">No address selected. <a href="/saved-addresses.html" class="text-orange-500">Add one</a>.</p>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6 md:max-w-md md:mx-auto" id="order-summary">
                <h2 class="font-bold mb-3">Order Summary</h2>
                <div class="space-y-3 mb-3" id="order-items"></div>
                <div class="border-t border-gray-200 pt-3 mb-3" id="summary-details">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-medium" id="subtotal">₦0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Delivery Fee</span>
                        <span class="font-medium" id="delivery-fee">₦0</span>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3">
                    <div class="flex justify-between">
                        <span class="font-bold">Total</span>
                        <span class="font-bold text-orange-500" id="total">₦0</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <h2 class="font-bold mb-3">Payment Method</h2>
                <div class="space-y-3" id="payment-methods"></div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <h2 class="font-bold mb-3">Order Notes (Optional)</h2>
                <textarea class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-transparent" 
                          rows="3" placeholder="Any special instructions for delivery..." id="order-notes" aria-label="Order notes"></textarea>
            </div>
            <button class="w-full py-3 bg-orange-500 text-white rounded-full font-bold ripple mb-6" id="place-order" aria-label="Place order">
                Place Order
            </button>
        </div>
    </main>
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 z-10" role="navigation" aria-label="Main navigation">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center text-gray-500">
                <i data-feather="home" class="w-6 h-6" aria-hidden="true"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="categories.html" class="flex flex-col items-center text-gray-500">
                <i data-feather="grid" class="w-6 h-6" aria-hidden="true"></i>
                <span class="text-xs mt-1">Categories</span>
            </a>
            <a href="cart.html" class="flex flex-col items-center text-gray-500">
                <div class="relative">
                    <i data-feather="shopping-cart" class="w-6 h-6" aria-hidden="true"></i>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center" aria-label="Cart items count">0</span>
                </div>
                <span class="text-xs mt-1">Cart</span>
            </a>
            <a href="orders.html" class="flex flex-col items-center text-gray-500">
                <i data-feather="package" class="w-6 h-6" aria-hidden="true"></i>
                <span class="text-xs mt-1">Orders</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-gray-500">
                <i data-feather="user" class="w-6 h-6" aria-hidden="true"></i>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </nav>
    <script>
        feather.replace();
        const API_BASE_URL = 'http://localhost:5000/api';
        const DELIVERY_FEE = 5000;
        const PAYSTACK_PUBLIC_KEY = 'pk_test_ef1440e093365ca4a90cc345374aa9fa168064c9';

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} shadow-lg`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { toast.remove(); }, 300); }, 2000);
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Please log in to proceed with checkout.', 'error');
                setTimeout(() => { window.location.href = '/login.html?redirect=checkout'; }, 2000);
                return false;
            }
            return true;
        }

        function setupAuthUI() {
            const authLinks = document.getElementById('auth-links');
            if (!authLinks) {
                console.error('Auth links element not found');
                showToast('UI error: Auth links missing.', 'error');
                return;
            }
            authLinks.innerHTML = '';
        }

        function showShimmer() {
            const checkoutLoader = document.getElementById('checkout-loader');
            const checkoutContent = document.getElementById('checkout-content');
            if (!checkoutLoader || !checkoutContent) {
                console.error('Loader elements not found:', {
                    checkoutLoader: !!checkoutLoader,
                    checkoutContent: !!checkoutContent
                });
                showToast('UI error: Checkout loader missing.', 'error');
                const main = document.querySelector('main');
                if (main) {
                    main.innerHTML = '<p class="text-center text-gray-500">Loading checkout...</p>';
                }
                return;
            }
            checkoutLoader.classList.remove('hidden');
            checkoutContent.classList.add('hidden');
        }

        function hideShimmer() {
            const checkoutLoader = document.getElementById('checkout-loader');
            const checkoutContent = document.getElementById('checkout-content');
            if (!checkoutLoader || !checkoutContent) {
                console.error('Loader elements not found:', {
                    checkoutLoader: !!checkoutLoader,
                    checkoutContent: !!checkoutContent
                });
                showToast('UI error: Checkout content missing.', 'error');
                return;
            }
            checkoutLoader.classList.add('hidden');
            checkoutContent.classList.remove('hidden');
        }

        async function fetchCheckoutData(retryCount = 0, maxRetries = 2) {
            console.log('Fetching checkout data, checking DOM elements:', {
                checkoutLoader: !!document.getElementById('checkout-loader'),
                checkoutContent: !!document.getElementById('checkout-content')
            });
            showShimmer();
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/checkout`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.status === 401) {
                    console.warn('Unauthorized access, clearing token');
                    localStorage.removeItem('token');
                    showToast('Session expired. Please log in.', 'error');
                    setTimeout(() => { window.location.href = '/login.html?redirect=checkout'; }, 2000);
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.message || response.status;
                    if (errorData.message === 'Cart is empty') {
                        hideShimmer();
                        showToast('Your cart is empty. Please add items to proceed.', 'error');
                        setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                        return;
                    }
                    throw new Error(`Failed to fetch checkout data: ${errorMessage}`);
                }
                const data = await response.json();
                console.log('Checkout data received:', JSON.stringify(data, null, 2));
                hideShimmer();
                renderCheckoutData(data);
                updateCartCount(data.cart);
                window.checkoutData = data;
            } catch (error) {
                console.error('Error fetching checkout data:', error.message);
                if (retryCount < maxRetries && !error.message.includes('401') && !error.message.includes('Cart is empty')) {
                    console.log(`Retrying fetchCheckoutData (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return fetchCheckoutData(retryCount + 1, maxRetries);
                }
                hideShimmer();
                const main = document.querySelector('main');
                if (main) {
                    main.innerHTML = '<p class="text-center text-gray-500">Failed to load checkout data. Please try again.</p>';
                }
                showToast(`Failed to load checkout data: ${error.message}`, 'error');
            }
        }

        function renderCheckoutData(data) {
            const addressContainer = document.getElementById('address-container');
            if (!addressContainer) {
                console.error('Address container not found');
                showToast('UI error: Address container missing.', 'error');
                return;
            }
            if (data.defaultAddress) {
                addressContainer.innerHTML = `
                    <p class="font-medium">${data.defaultAddress.label || 'Default Address'}</p>
                    <p class="text-sm text-gray-600">${data.defaultAddress.phone || 'N/A'}</p>
                    <p class="text-sm text-gray-600 mt-1">${data.defaultAddress.street}, ${data.defaultAddress.city}, ${data.defaultAddress.state || 'N/A'}, ${data.defaultAddress.country || 'Nigeria'}</p>
                `;
            } else {
                addressContainer.innerHTML = '<p class="text-sm text-gray-600">No address selected. <a href="/saved-addresses.html" class="text-orange-500">Add one</a>.</p>';
            }

            const orderItems = document.getElementById('order-items');
            const summaryDetails = document.getElementById('summary-details');
            const totalContainer = document.getElementById('total');
            if (!orderItems || !summaryDetails || !totalContainer) {
                console.error('Order summary elements not found:', {
                    orderItems: !!orderItems,
                    summaryDetails: !!summaryDetails,
                    totalContainer: !!totalContainer
                });
                showToast('UI error: Order summary elements missing.', 'error');
                return;
            }
            orderItems.innerHTML = data.cart && data.cart.length > 0 ? data.cart.map(item => `
                <div class="flex justify-between">
                    <span class="text-gray-600">${item.product?.name || 'Unknown Product'} × ${item.quantity || 0}</span>
                    <span class="font-medium">₦${((item.product?.price || 0) * (item.quantity || 0)).toLocaleString()}</span>
                </div>
            `).join('') : '<p class="text-gray-600">No items in cart.</p>';

            summaryDetails.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Subtotal</span>
                    <span class="font-medium" id="subtotal">₦${data.summary?.subtotal?.toLocaleString() || '0'}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Delivery Fee</span>
                    <span class="font-medium" id="delivery-fee">₦${data.summary?.deliveryFee?.toLocaleString() || '0'}</span>
                </div>
            `;
            totalContainer.textContent = `₦${data.summary?.total?.toLocaleString() || '0'}`;

            const paymentContainer = document.getElementById('payment-methods');
            if (!paymentContainer) {
                console.error('Payment methods container not found');
                showToast('UI error: Payment methods container missing.', 'error');
                return;
            }
            paymentContainer.innerHTML = `
                <div class="payment-method border rounded-lg p-3 flex items-center cursor-pointer active" data-payment-type="cash" role="button" aria-label="Select Pay on Delivery">
                    <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mr-3">
                        <i data-feather="dollar-sign" class="text-orange-500 w-4 h-4" aria-hidden="true"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium">Pay on Delivery</p>
                        <p class="text-xs text-gray-500">Pay cash when your order arrives</p>
                    </div>
                    <i data-feather="check" class="text-orange-500 w-5 h-5" aria-hidden="true"></i>
                </div>
                <div class="payment-method border rounded-lg p-3 flex items-center cursor-pointer" data-payment-type="paystack" role="button" aria-label="Select Pay with Paystack">
                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                        <i data-feather="credit-card" class="text-gray-500 w-4 h-4" aria-hidden="true"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium">Pay with Paystack</p>
                        <p class="text-xs text-gray-500">Card, Bank Transfer, USSD, and more</p>
                    </div>
                    <i data-feather="check" class="text-orange-500 w-5 h-5 hidden" aria-hidden="true"></i>
                </div>
            `;
            if (data.paymentMethods && Array.isArray(data.paymentMethods)) {
                data.paymentMethods.forEach(payment => {
                    const isCard = payment.type === 'card';
                    const isBank = payment.type === 'bank';
                    if (!isCard && !isBank) {
                        console.warn('Invalid payment method type:', payment.type);
                        return;
                    }
                    const number = isCard ? payment.cardNumber : payment.accountNumber;
                    const displayNumber = (number && typeof number === 'string' && number.length >= 4) ? `****${number.slice(-4)}` : '****XXXX';
                    paymentContainer.innerHTML += `
                        <div class="payment-method border border-gray-200 rounded-lg p-3 flex items-center cursor-pointer ${payment.isDefault && data.defaultAddress ? 'active' : ''}" data-payment-type="${payment.type}" role="button" aria-label="Select ${isCard ? 'Card Payment' : 'Bank Transfer'}">
                            <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                                <i data-feather="${isCard ? 'credit-card' : 'repeat'}" class="text-gray-500 w-4 h-4" aria-hidden="true"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium">${isCard ? 'Card Payment' : 'Bank Transfer'}</p>
                                <p class="text-xs text-gray-500">${displayNumber}</p>
                            </div>
                            <i data-feather="check" class="text-orange-500 w-5 h-5 ${payment.isDefault && data.defaultAddress ? '' : 'hidden'}" aria-hidden="true"></i>
                        </div>
                    `;
                });
            }

            feather.replace();
            setupPaymentSelection();
        }

        function setupPaymentSelection() {
            const paymentMethods = document.querySelectorAll('.payment-method');
            if (!paymentMethods.length) {
                console.warn('No payment methods found for event listener setup');
                showToast('No payment methods available.', 'error');
                return;
            }
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    if ('vibrate' in navigator) {
                        navigator.vibrate(50);
                    }
                    paymentMethods.forEach(m => {
                        m.classList.remove('active');
                        const iconContainer = m.querySelector('div:first-child');
                        if (iconContainer) {
                            iconContainer.classList.remove('bg-orange-100');
                            iconContainer.classList.add('bg-gray-100');
                        }
                        const checkIcon = m.querySelector('i:last-child');
                        if (checkIcon) checkIcon.classList.add('hidden');
                    });
                    this.classList.add('active');
                    const iconContainer = this.querySelector('div:first-child');
                    if (iconContainer) {
                        iconContainer.classList.remove('bg-gray-100');
                        iconContainer.classList.add('bg-orange-100');
                    }
                    const checkIcon = this.querySelector('i:last-child');
                    if (checkIcon) checkIcon.classList.remove('hidden');
                    console.log(`Selected payment method: ${this.getAttribute('data-payment-type')}`);
                });
            });
        }

        function updateCartCount(cart) {
            const count = cart && Array.isArray(cart) ? cart.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                cartCount.textContent = count;
                cartCount.setAttribute('aria-label', `Cart items count: ${count}`);
                cartCount.classList.toggle('animate-bounce', count > 0);
            }
        }

        async function verifyPaystackPayment(reference, orderId) {
            try {
                const token = localStorage.getItem('token');
                const verifyResponse = await fetch(`${API_BASE_URL}/checkout/verify-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        reference,
                        orderId
                    }),
                });
                if (!verifyResponse.ok) {
                    const errorData = await verifyResponse.json().catch(() => ({}));
                    throw new Error(`Payment verification failed: ${errorData.message || verifyResponse.status}`);
                }
                const verification = await verifyResponse.json();
                if (verification.status === 'success') {
                    showToast(`Order placed successfully! Order #${verification.orderNumber}`, 'success');
                    setTimeout(() => { window.location.href = '/orders.html'; }, 2000);
                } else {
                    throw new Error('Payment verification failed: Invalid status');
                }
            } catch (error) {
                console.error('Error verifying payment:', error.message);
                showToast(`Payment verification failed: ${error.message}. Please contact support.`, 'error');
            }
        }

        async function initiatePaystackPayment(total, email, orderData, retryCount = 0, maxRetries = 2) {
            try {
                const handler = PaystackPop.setup({
                    key: PAYSTACK_PUBLIC_KEY,
                    email: email || 'customer@example.com',
                    amount: total * 100,
                    currency: 'NGN',
                    ref: 'TX-' + Math.floor((Math.random() * 1000000000) + 1),
                    metadata: {
                        orderId: orderData.orderId || 'pending',
                        custom_fields: [
                            {
                                display_name: "Order Notes",
                                variable_name: "order_notes",
                                value: orderData.orderNotes || ''
                            }
                        ]
                    },
                    callback: function(response) {
                        console.log('Paystack payment completed, reference:', response.reference);
                        verifyPaystackPayment(response.reference, orderData.orderId);
                    },
                    onClose: function() {
                        console.log('Paystack payment window closed');
                        showToast('Payment cancelled. Please try again or choose another payment method.', 'error');
                    }
                });
                handler.openIframe();
            } catch (error) {
                console.error('Error initiating Paystack payment:', error.message);
                if (retryCount < maxRetries) {
                    console.log(`Retrying initiatePaystackPayment (${retryCount + 1}/${maxRetries})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return initiatePaystackPayment(total, email, orderData, retryCount + 1, maxRetries);
                }
                showToast(`Failed to initiate payment: ${error.message}. Please try again.`, 'error');
            }
        }

        async function placeOrder(retryCount = 0, maxRetries = 2) {
            try {
                if ('vibrate' in navigator) {
                    navigator.vibrate(50);
                }
                const token = localStorage.getItem('token');
                const addressContainer = document.getElementById('address-container');
                if (!addressContainer.querySelector('p.font-medium')) {
                    showToast('Please select a delivery address.', 'error');
                    setTimeout(() => { window.location.href = '/saved-addresses.html'; }, 2000);
                    return;
                }

                const selectedPayment = document.querySelector('.payment-method.active');
                if (!selectedPayment) {
                    showToast('Please select a payment method.', 'error');
                    return;
                }
                const paymentType = selectedPayment.getAttribute('data-payment-type');
                if (!paymentType) {
                    showToast('Invalid payment method selected.', 'error');
                    return;
                }
                const paymentMethod = paymentType === 'cash' ? 'Pay on Delivery' : 
                                      paymentType === 'paystack' ? 'Paystack' : 
                                      paymentType === 'card' ? 'Card Payment' : 
                                      paymentType === 'bank' ? 'Bank Transfer' : 
                                      selectedPayment.querySelector('p.font-medium').textContent;
                console.log('Selected payment method:', { paymentType, paymentMethod });

                const orderNotes = document.getElementById('order-notes').value.trim();
                const cart = window.checkoutData?.cart || [];
                const items = cart.map(item => {
                    if (!item.product?._id || !item.quantity || !item.product?.price) {
                        console.error('Invalid cart item:', item);
                        throw new Error('Invalid cart item: missing product ID, quantity, or price');
                    }
                    return {
                        product: item.product._id,
                        quantity: item.quantity,
                        price: item.product.price
                    };
                });

                if (!items.length) {
                    showToast('Your cart is empty. Please add items to proceed.', 'error');
                    setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                    return;
                }

                const addressResponse = await fetch(`${API_BASE_URL}/addresses`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                });
                if (addressResponse.status === 401) {
                    console.warn('Unauthorized access, clearing token');
                    localStorage.removeItem('token');
                    showToast('Session expired. Please log in.', 'error');
                    setTimeout(() => { window.location.href = '/login.html?redirect=checkout'; }, 2000);
                    return;
                }
                if (!addressResponse.ok) {
                    const errorData = await addressResponse.json().catch(() => ({}));
                    throw new Error(`Failed to fetch addresses: ${errorData.message || addressResponse.status}`);
                }
                const addresses = await addressResponse.json();
                console.log('Addresses fetched:', JSON.stringify(addresses, null, 2));
                const defaultAddress = addresses.find(addr => addr.isDefault);
                if (!defaultAddress) {
                    showToast('Please set a default delivery address.', 'error');
                    setTimeout(() => { window.location.href = '/saved-addresses.html'; }, 2000);
                    return;
                }
                if (!defaultAddress.state || !defaultAddress.country) {
                    showToast('Selected address is invalid (missing state or country). Please update your address.', 'error');
                    setTimeout(() => { window.location.href = '/saved-addresses.html'; }, 2000);
                    return;
                }

                const requestBody = {
                    items,
                    deliveryAddress: defaultAddress._id,
                    paymentMethod,
                    orderNotes
                };
                console.log('Sending order request to /api/orders:', JSON.stringify(requestBody, null, 2));

                const orderResponse = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(requestBody),
                });
                if (!orderResponse.ok) {
                    const errorData = await orderResponse.json().catch(() => ({}));
                    console.error('Order request failed:', JSON.stringify(errorData, null, 2));
                    if (errorData.message === 'Delivery address not found') {
                        showToast('Invalid delivery address. Please select a valid address.', 'error');
                        setTimeout(() => { window.location.href = '/saved-addresses.html'; }, 2000);
                        return;
                    }
                    if (errorData.message === 'Invalid payment method') {
                        showToast('Invalid payment method selected. Please try again.', 'error');
                        return;
                    }
                    if (errorData.message.includes('Items array is required')) {
                        showToast('Your cart is empty or invalid. Please add items to proceed.', 'error');
                        setTimeout(() => { window.location.href = '/cart.html'; }, 2000);
                        return;
                    }
                    if (retryCount < maxRetries) {
                        console.log(`Retrying placeOrder (${retryCount + 1}/${maxRetries})...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return placeOrder(retryCount + 1, maxRetries);
                    }
                    throw new Error(`Failed to place order: ${errorData.message || orderResponse.status}`);
                }

                const order = await orderResponse.json();
                console.log('Order placed successfully:', JSON.stringify(order, null, 2));

                if (paymentType === 'paystack') {
                    const userEmail = window.checkoutData?.user?.email || 'customer@example.com';
                    const total = window.checkoutData?.summary?.total || 0;
                    await initiatePaystackPayment(total, userEmail, {
                        orderId: order._id,
                        orderNotes
                    });
                } else {
                    showToast(`Order placed successfully! Order #${order.orderNumber}`, 'success');
                    setTimeout(() => { window.location.href = '/orders.html'; }, 2000);
                }
            } catch (error) {
                console.error('Error placing order:', error.message);
                showToast(`Failed to place order: ${error.message}. Please try again.`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                setupAuthUI();
                fetchCheckoutData();
                document.getElementById('place-order').addEventListener('click', placeOrder);
                document.getElementById('change-address').addEventListener('click', () => {
                    window.location.href = '/saved-addresses.html';
                });
            }
        });
    </script>
</body>
</html>